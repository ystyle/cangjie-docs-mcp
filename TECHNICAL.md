# 仓颉语言文档检索系统 - 技术设计文档

## 系统架构

### 整体设计

```
用户 (Claude Code) → MCP协议 → 仓颉文档MCP服务器 → 本地文档系统↓
              stdio通信协议↓
              文档检索引擎
```

### 核心组件

| 组件 | 职责 |
|------|------|
| 文档扫描器 | 自动扫描和解析文档，支持大文档分割 |
| 搜索引擎 | 三级搜索算法实现，支持中文分词 |
| MCP服务器 | 协议处理和工具接口暴露 |
| 索引系统 | 倒排索引和元数据管理 |
| Skill 扩展 | 智能检索助手 |

### 文档源

- **官方文档仓库**: https://gitcode.com/Cangjie/CangjieCorpus
- **文档格式**: Markdown
- **自动更新**: 每次启动时检测并拉取最新文档

## 文档分类体系

### 五大分类

| 分类 | 内容 | 说明 |
|------|------|------|
| manual | 基础手册 | 语法、类型系统、函数、类等基础教程 |
| libs | 标准库API | std 标准库和 stdx 扩展库 |
| tools | 开发工具 | cjpm、编译器、调试器等 |
| extra | 额外内容 | 高级主题、最佳实践 |
| ohos | OpenHarmony | 鸿蒙平台开发文档 |

### 层级结构

```
分类 → 子分类→ 目录 → 文档
```

支持类似文件系统的渐进式浏览。

## MCP 工具设计

### 工具清单

| 工具 | 用途 | 典型场景 |
|------|------|----------|
| cangjie_docs_overview | 文档总览 | 了解文档结构、统计信息 |
| cangjie_list_docs | 列出文档 | 浏览特定分类/目录下的文档 |
| cangjie_search | 搜索文档 | 关键词查找相关文档 |
| cangjie_get_doc | 获取文档 | 读取文档完整内容 |

### 设计原则

1. **渐进式披露**: 从概览到详情，逐层深入
2. **Token 高效**: 优先返回摘要，按需获取详情
3. **灵活过滤**: 支持分类、路径、相关性等多维度筛选

### cangjie_docs_overview

获取文档全局视图，支持三种输出格式：

| 视图 | 格式 | 适用场景 |
|------|------|----------|
| overview | JSON | 分类统计、数量概览 |
| map | JSON | 文档层级关系 |
| navigation/tree | 文本树 | 节省 Token 的导航浏览 |

### cangjie_list_docs

渐进式文档浏览，行为随路径深度变化：

| 深度 | 行为 | 示例 |
|------|------|------|
| 0 | 显示子分类列表 | libs → std, stdx |
| 1 | 显示一级目录 | libs/std → core, collection |
| 2+ | 显示文档列表 | libs/std/core → 具体文档 |

### cangjie_search

多关键词 AND 匹配搜索：

- 单个关键词：直接匹配
- 多个关键词（空格分隔）：所有关键词都必须出现
- 支持分类过滤和相关性阈值

### cangjie_get_doc

获取文档内容，支持：

- 多种输出格式：Markdown / JSON / 纯文本
- 章节提取：只获取特定章节内容
- 元数据控制：是否包含文档属性

## 搜索算法设计

### 三级搜索策略

| 级别 | 匹配方式 | 权重 | 说明 |
|------|----------|------|------|
| 1 | 精确匹配 | 10.0 | 标题/描述/关键词完全包含查询词 |
| 2 | 索引匹配 | 8.0/6.0 | 通过倒排索引快速定位 |
| 3 | 模糊匹配 | 3.0 | 内容全文搜索 |

### 相关性评分因素

- 标题匹配度
- 描述匹配度
- 关键词命中
- 文件名相关性
- 内容出现频率

### 中文支持

- 使用正则提取中英文词汇
- 停用词过滤（的、了、在、是、the、a 等）
- 大小写不敏感

## 文档分割机制

### 设计目标

大文档会影响 AI处理效率和搜索精度，需要自动分割。

### 分割策略

| 参数 | 值 | 说明 |
|------|-----|------|
| 触发阈值 | 15KB | 超过此大小触发分割 |
| 分割粒度 | 二级标题 (##) | 按章节分割 |
| 递归分割 | 否 | 保持结构体/类的完整性 |

### 关联保留

分割后的子文档通过元数据关联父文档，支持追溯完整上下文。

### 实际效果

- 92.3% 的文档大小在 0-5KB 范围
- 搜索结果直接定位到相关章节
- 大幅降低 AI 处理压力

## Token 优化策略

### 输出格式选择

| 格式 | 使用场景 | Token 节省 |
|------|----------|-----------|
| 文本树形 | 导航浏览 | ~75% |
| Markdown 表格 | 文档列表 | ~60% |
| JSON | 结构化数据 | 基准 |

### 设计原则

1. **默认简洁**: 列表操作默认只返回摘要
2. **按需详情**: 通过参数控制是否包含完整内容
3. **格式优先**: 优先选择 Token 效率高的输出格式

## Skill 扩展

### cangjie-docs-navigator

智能文档检索 Skill，提供 4 种搜索模式：

| 模式 | 触发条件 | 策略 |
|------|----------|------|
| 直接搜索 | 精确 API 名称 | 调用搜索工具 |
| PageIndex 智能检索 | 模糊功能描述 | 目录树导航 |
| 混合模式 | 不确定查询精确度 | 先搜索后导航 |
| 探索模式 | 开放性问题 | 展示文档体系引导 |

### 安装方式

- GitHub: `npx skills add ystyle/cangjie-docs-mcp`
- 国内镜像: `npx skills add https://atomgit.com/Cangjie-SIG/cangjie-docs-mcp`

## 配置设计

### 零配置理念

- 文档自动下载到默认位置
- 每次启动自动更新
- 无需手动配置索引

### 可选参数

| 参数 | 用途 |
|------|------|
| -dir | 自定义文档目录 |
| -no-update | 禁用自动更新（离线模式） |

## 错误处理

### 错误类型

- 文档不存在
- 目录访问错误
- 索引构建失败
- 参数验证失败

### 日志策略

关键操作记录日志，便于问题排查。

## 性能目标

| 指标 | 目标值 |
|------|--------|
| 搜索响应 | <200ms |
| 索引构建 | 启动时一次性完成 |
| Token 效率 | 文本格式节省 60-75% |
